<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Soundboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Fredoka', sans-serif;
      background: #fff4d6;
      color: #333;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #ff9800;
    }
    .premium-banner {
      position: fixed;
      top: 10px;
      right: 10px;
      background: gold;
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-weight: bold;
      display: none;
    }
    #admin-toggle {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 0.000005cm;
      height: 0.000005cm;
      background: transparent;
      border: none;
      cursor: pointer;
      opacity: 0;
    }
    #admin-panel {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fff3e0;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #admin-panel input, #admin-panel button {
      display: block;
      margin-top: 5px;
    }
    input, button {
      font-size: 16px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px 0;
    }
    button {
      background: #ffb74d;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      transform: scale(1.05);
      background: #ffa726;
    }
    input[type="file"]::file-selector-button {
      background: #ffcc80;
      border: none;
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
    }
    input[type="file"] {
      margin: 5px 0;
    }
    .sound img {
      width: 0.8cm;
      height: 0.8cm;
      object-fit: cover;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="premium-banner" id="premium-banner">🌟 Premium activé</div>
  <h1>🎵 Soundboard 🎵</h1>

  <div id="infos"></div>

  <div id="soundboards-tabs"></div>

  <input id="new-board-name" placeholder="Nom du nouveau soundboard">
  <button onclick="createNewBoard()">Créer</button>

  <hr>

  <input id="sound-name" placeholder="Nom du son">
  <input type="file" id="sound-file" accept="audio/*">
  <input type="file" id="sound-image" accept="image/*">
  <button id="add-sound-btn" onclick="addSound()">Ajouter le son</button>

  <div id="soundboards-container"></div>

  <hr>

  <button onclick="exportJSON()">📤 Exporter</button>
  <input type="file" onchange="importJSON(event)">

  <div id="premium-section">
    <input id="premium-code" placeholder="Code Premium">
    <button onclick="activerPremium()">Activer Premium</button>
  </div>

  <button id="admin-toggle" onclick="document.getElementById('admin-panel').style.display = 'block'"></button>
  <div id="admin-panel">
    <input id="admin-user" placeholder="Admin utilisateur">
    <input id="admin-pass" placeholder="Mot de passe" type="password">
    <button onclick="verifierAdmin()">Connexion</button>
    <div id="code-gen-section" style="display:none">
      <button onclick="genererCode()">Générer un code premium</button>
      <div id="dernier-code"></div>
    </div>
  </div>

  <script>
    const MAX_NON_PREMIUM_DURATION = 40;
    const MAX_PREMIUM_DURATION = 120;
    const MAX_SONS_NON_PREMIUM = 10;
    let CODES_VALIDES = JSON.parse(localStorage.getItem("codes_valides")) || [];

    let currentBoard = "Default";
    let soundboards = JSON.parse(localStorage.getItem("soundboards")) || { "Default": [] };

    function enregistrer() {
      localStorage.setItem("soundboards", JSON.stringify(soundboards));
    }

    function enregistrerCodes() {
      localStorage.setItem("codes_valides", JSON.stringify(CODES_VALIDES));
    }

    function estPremium() {
      return localStorage.getItem("premium") === "true";
    }

    function activerPremium() {
      const code = document.getElementById("premium-code").value.trim();
      const index = CODES_VALIDES.indexOf(code);
      if (index !== -1) {
        localStorage.setItem("premium", "true");
        CODES_VALIDES.splice(index, 1);
        enregistrerCodes();
        alert("🎉 Premium activé avec succès !");
        document.getElementById("premium-section").style.display = "none";
        document.getElementById("premium-banner").style.display = "block";
        afficherPremium();
      } else {
        alert("❌ Code invalide !");
      }
    }

    function afficherPremium() {
      const infos = document.getElementById("infos");
      if (estPremium()) {
        infos.innerText = "✅ Premium activé — Durée max : 2 minutes.";
        document.getElementById("premium-banner").style.display = "block";
        document.getElementById("premium-section").style.display = "none";
      } else {
        infos.innerText = `🔒 Version gratuite : max ${MAX_SONS_NON_PREMIUM} sons / Durée max : 20 secondes.`;
        document.getElementById("premium-banner").style.display = "none";
        document.getElementById("premium-section").style.display = "block";
      }
    }

    function updateTabs() {
      const tabs = document.getElementById("soundboards-tabs");
      tabs.innerHTML = "";
      Object.keys(soundboards).forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = () => {
          currentBoard = name;
          afficherSoundboard();
        };
        const delBtn = document.createElement("button");
        delBtn.textContent = "🗑️";
        delBtn.onclick = () => {
          if (confirm(`Supprimer la liste \"${name}\" ?`)) {
            delete soundboards[name];
            currentBoard = Object.keys(soundboards)[0] || "Default";
            enregistrer();
            updateTabs();
            afficherSoundboard();
          }
        };
        const wrapper = document.createElement("div");
        wrapper.style.display = "inline-block";
        wrapper.style.marginRight = "5px";
        wrapper.appendChild(btn);
        wrapper.appendChild(delBtn);
        tabs.appendChild(wrapper);
      });
    }

    function createNewBoard() {
      const name = document.getElementById("new-board-name").value.trim();
      if (!name || soundboards[name]) return alert("Nom invalide ou déjà utilisé");
      soundboards[name] = [];
      currentBoard = name;
      enregistrer();
      updateTabs();
      afficherSoundboard();
    }

    function afficherSoundboard() {
      const container = document.getElementById("soundboards-container");
      container.innerHTML = "";
      (soundboards[currentBoard] || []).forEach((son, i) => {
        const div = document.createElement("div");
        div.className = "sound";

        const img = document.createElement("img");
        img.src = son.image || "https://via.placeholder.com/50";

        const btn = document.createElement("button");
        btn.textContent = son.nom;
        btn.onclick = () => {
          const audio = new Audio(son.audio);
          audio.play();
        };

        const del = document.createElement("button");
        del.textContent = "❌";
        del.onclick = () => {
          soundboards[currentBoard].splice(i, 1);
          enregistrer();
          afficherSoundboard();
        };

        div.appendChild(img);
        div.appendChild(btn);
        div.appendChild(del);
        container.appendChild(div);
      });
    }

    function addSound() {
      const name = document.getElementById("sound-name").value.trim();
      const file = document.getElementById("sound-file").files[0];
      const image = document.getElementById("sound-image").files[0];

      if (!name || !file) return alert("Nom ou fichier audio manquant.");

      if (!estPremium() && soundboards[currentBoard].length >= MAX_SONS_NON_PREMIUM) {
        alert("❌ Limite atteinte : passe en Premium pour plus de sons.");
        return;
      }

      const readerAudio = new FileReader();
      readerAudio.onload = () => {
        const audioURL = readerAudio.result;
        const audio = new Audio(audioURL);
        audio.onloadedmetadata = () => {
          const duration = audio.duration;
          if ((!estPremium() && duration > MAX_NON_PREMIUM_DURATION) || (estPremium() && duration > MAX_PREMIUM_DURATION)) {
            alert(`⛔ Ce fichier fait ${Math.round(duration)} secondes. Limite ${estPremium() ? MAX_PREMIUM_DURATION : MAX_NON_PREMIUM_DURATION} secondes.`);
            return;
          }

          const readerImage = new FileReader();
          readerImage.onload = () => {
            const imageURL = image ? readerImage.result : "https://via.placeholder.com/50";
            soundboards[currentBoard].push({ nom: name, audio: audioURL, image: imageURL });
            enregistrer();
            afficherSoundboard();
          };
          if (image) readerImage.readAsDataURL(image);
          else readerImage.onload();
        };
      };
      readerAudio.readAsDataURL(file);
    }

    function exportJSON() {
      const blob = new Blob([JSON.stringify(soundboards)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "soundboards.json";
      a.click();
    }

    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          soundboards = JSON.parse(reader.result);
          currentBoard = Object.keys(soundboards)[0] || "Default";
          enregistrer();
          updateTabs();
          afficherSoundboard();
        } catch (e) {
          alert("Erreur de lecture du fichier JSON");
        }
      };
      reader.readAsText(file);
    }

    function genererCode() {
      const charset = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let code = '';
      for (let i = 0; i < 28; i++) {
        code += charset[Math.floor(Math.random() * charset.length)];
      }
      CODES_VALIDES.push(code);
      enregistrerCodes();
      document.getElementById("dernier-code").innerText = `Code généré : ${code}`;
    }

    function verifierAdmin() {
      const user = document.getElementById("admin-user").value;
      const pass = document.getElementById("admin-pass").value;
      if (user === "7K2@9F48W3M" && pass === "D5N82VM@T9Q") {
        document.getElementById("code-gen-section").style.display = "block";
      } else {
        alert("Accès refusé");
      }
    }

    afficherPremium();
    updateTabs();
    afficherSoundboard();
  </script>
</body>
</html>
